{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "(v15.0) AWS CFT to deploy a dual AZ A-P solution, repo: https://github.com/FortinetCloudCSE/fortigate-aws-ha-dualaz-cloudformation",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "New VPC Configuration"
					},
					"Parameters": [
						"VPCCIDR",
						"AZForSubnet1",
						"AZForSubnet2",
						"PublicSubnet1CIDR",
						"PrivateSubnet1CIDR",
						"HAMgmtSubnet1CIDR",
						"PublicSubnet2CIDR",
						"PrivateSubnet2CIDR",
						"HAMgmtSubnet2CIDR",
						"Attachment",
						"AttachmentSubnet1CIDR",
						"AttachmentSubnet2CIDR"
					]
				},
				{
					"Label": {
						"default": "TGW Configuration"
					},
					"Parameters": [
						"TgwCreation",
						"TgwExisting",
						"TgwExistingSecurityTgwRtb",
						"TgwExistingSpokeTgwRtb",
						"TgwExistingSpokeTgwRtbRoute"
					]
				},
				{
					"Label": {
						"default": "CWAN Configuration"
					},
					"Parameters": [
						"CwanCreation",
						"CwanExisting",
						"CwanExistingSegmentKey",
						"CwanExistingSegmentValue"
					]
				},
				{
					"Label": {
						"default": "FortiGate Instance Configuration"
					},
					"Parameters": [
						"InstanceType",
						"CIDRForInstanceAccess",
						"KeyPair",
						"EncryptVolumes",
						"OnlyPrivateEC2API",
						"FortiOSVersion",
						"LicenseType",
						"InitS3Bucket",
						"FortiGate1LicenseFile",
						"FortiGate2LicenseFile",
						"FortiGate1FortiFlexToken",
						"FortiGate2FortiFlexToken",
						"PublicSubnet1RouterIP",
						"PrivateSubnet1RouterIP",
						"HAMgmtSubnet1RouterIP",
						"PublicSubnet2RouterIP",
						"PrivateSubnet2RouterIP",
						"HAMgmtSubnet2RouterIP"
					]
				},
				{
					"Label": {
						"default": "Interface IP Configuration for FortiGate 1"
					},
					"Parameters": [
						"FortiGate1PublicIP",
						"FortiGate1PrivateIP",
						"FortiGate1HAmgmtIP"
					]
				},
				{
					"Label": {
						"default": "Interface IP Configuration for FortiGate 2"
					},
					"Parameters": [
						"FortiGate2PublicIP",
						"FortiGate2PrivateIP",
						"FortiGate2HAmgmtIP"
					]
				}
			]
		}
	},
	"Parameters": {
		"VPCCIDR": {
			"Type": "String",
			"Default": "10.0.0.0/16",
			"Description": "Provide a network CIDR for the new VPC",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"AZForSubnet1": {
			"Type": "AWS::EC2::AvailabilityZone::Name",
			"Description": "Select an Availability Zone for the first set of new subnets"
		},
		"AZForSubnet2": {
			"Type": "AWS::EC2::AvailabilityZone::Name",
			"Description": "Select an Availability Zone for the second set of new subnets"
		},
		"PublicSubnet1CIDR": {
			"Type": "String",
			"Default": "10.0.1.0/24",
			"Description": "[Provide a network CIDR for PublicSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PrivateSubnet1CIDR": {
			"Type": "String",
			"Default": "10.0.2.0/24",
			"Description": "Provide a network CIDR for PrivateSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"HAMgmtSubnet1CIDR": {
			"Type": "String",
			"Default": "10.0.3.0/24",
			"Description": "Provide a network CIDR for HAMgmtSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PublicSubnet2CIDR": {
			"Type": "String",
			"Default": "10.0.10.0/24",
			"Description": "Provide a network CIDR for PublicSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"PrivateSubnet2CIDR": {
			"Type": "String",
			"Default": "10.0.20.0/24",
			"Description": "Provide a network CIDR for PrivateSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"HAMgmtSubnet2CIDR": {
			"Type": "String",
			"Default": "10.0.30.0/24",
			"Description": "Provide a network CIDR for HAMgmtSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"Attachment": {
			"Type": "String",
			"Description": "Select Yes if you plan to attach this VPC to Transit GW or Cloud WAN with a VPC attachment.  If Yes is selected 2 additional subnets and a route table will be created",
			"AllowedValues": [
				"Yes",
				"No"
			]
		},
		"AttachmentSubnet1CIDR": {
			"Type": "String",
			"Default": "10.0.4.0/24",
			"Description": "Provide a network CIDR for AttachmentSubnet1",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"AttachmentSubnet2CIDR": {
			"Type": "String",
			"Default": "10.0.40.0/24",
			"Description": "Provide a network CIDR for AttachmentSubnet2",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"TgwCreation": {
			"Type": "String",
			"Description": "Select Yes if you want to deploy a new Transit GW and two Transit GW Route Tables",
			"AllowedValues": [
				"Yes",
				"No"
			]
		},
		"TgwExisting": {
			"Type": "String",
			"Description": "[Leave blank if an existing TGW will not be used] If you are using an existing Transit GW, provide the Transit GW ID to create VPC routes to reach it"
		},
		"TgwExistingSecurityTgwRtb": {
			"Type": "String",
			"Description": "[Leave blank if an existing TGW will not be used] If you are using an existing Transit GW, provide the Transit GW RouteTable ID for the security VPC to associate to"
		},
		"TgwExistingSpokeTgwRtb": {
			"Type": "String",
			"Description": "[Leave blank if an existing TGW will not be used] If you are using an existing Transit GW, provide the Transit GW RouteTable ID that your spoke VPCs are associated with"
		},
		"TgwExistingSpokeTgwRtbRoute": {
			"Type": "String",
			"Description": "[Leave blank if an existing TGW will not be used] If you are using an existing Transit GW, provide a network CIDR to create a route in your Transit GW RouteTable that your spoke VPCs are associated with (ie 10.0.0.0/8 or 0.0.0.0/0)"
		},
		"CwanCreation": {
			"Type": "String",
			"Description": "Select Yes if you want to deploy a new Cloud WAN network with production, development, sharedservices, and firewall segments",
			"AllowedValues": [
				"Yes",
				"No"
			]
		},
		"CwanExisting": {
			"Type": "String",
			"Description": "[Leave blank if an existing Cwan will not be used] If you are using an existing Cloud WAN, provide the Cloud WAN Core Network ID to create VPC routes to reach it"
		},
		"CwanExistingSegmentKey": {
			"Type": "String",
			"Description": "[Leave blank if an existing Cwan will not be used] Provide the name that should be used to create a Tag on the Cwan VPC Attachment to allow CWAN attachment automation"
		},
		"CwanExistingSegmentValue": {
			"Type": "String",
			"Description": "[Leave blank if an existing Cwan will not be used] Provide the value that should be used to create a Tag on the Cwan VPC Attachment to allow CWAN attachment automation"
		},
		"PublicSubnet1RouterIP": {
			"Type": "String",
			"Default": "10.0.1.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First Host IP from PublicSubnet1CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"PrivateSubnet1RouterIP": {
			"Type": "String",
			"Default": "10.0.2.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First IP from PrivateSubnet1CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"HAMgmtSubnet1RouterIP": {
			"Type": "String",
			"Default": "10.0.3.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First IP from HAMgmtSubnet1CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"PublicSubnet2RouterIP": {
			"Type": "String",
			"Default": "10.0.10.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First IP from PublicSubnet2CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"PrivateSubnet2RouterIP": {
			"Type": "String",
			"Default": "10.0.20.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First IP from PrivateSubnet2CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"HAMgmtSubnet2RouterIP": {
			"Type": "String",
			"Default": "10.0.30.1",
			"Description": "Provide the IP address of the AWS intrinsic router (First IP from HAMgmtSubnet2CIDR)",
			"AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.|$)){4}$",
			"ConstraintDescription": "Must be a valid IPv4 address in dotted-decimal format."
		},
		"FortiGate1PublicIP": {
			"Type": "String",
			"Default": "10.0.1.10/24",
			"Description": "Provide the IP address in CIDR form for the public interface of FortiGate1 (IP from PublicSubnet1CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiGate1PrivateIP": {
			"Type": "String",
			"Default": "10.0.2.10/24",
			"Description": "Provide the IP address in CIDR form for the private interface of FortiGate1 (IP from PrivateSubnet1CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiGate1HAmgmtIP": {
			"Type": "String",
			"Default": "10.0.3.10/24",
			"Description": "Provide the IP address in CIDR form for the ha management interface of FortiGate1 (IP from HAMgmtSubnet1CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiGate2PublicIP": {
			"Type": "String",
			"Default": "10.0.10.10/24",
			"Description": "Provide the IP address in CIDR form for the public interface of FortiGate2 (IP from PublicSubnet2CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiGate2PrivateIP": {
			"Type": "String",
			"Default": "10.0.20.10/24",
			"Description": "Provide the IP address in CIDR form for the private interface of FortiGate2 (IP from PrivateSubnet2CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"FortiGate2HAmgmtIP": {
			"Type": "String",
			"Default": "10.0.30.10/24",
			"Description": "Provide the IP address in CIDR form for the ha management interface of FortiGate2 (IP from HAMgmtSubnet2CIDR)",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block format."
		},
		"InstanceType": {
			"Type": "String",
			"Default": "c6i.xlarge",
			"Description": "Select the instance type for the FortiGates",
			"AllowedValues": [
				"c5.large",
				"c5.xlarge",
				"c5.2xlarge",
				"c5.4xlarge",
				"c5.9xlarge",
				"c5.18xlarge",
				"c5n.large",
				"c5n.xlarge",
				"c5n.2xlarge",
				"c5n.4xlarge",
				"c5n.9xlarge",
				"c5n.18xlarge",
				"c6i.large",
				"c6i.xlarge",
				"c6i.2xlarge",
				"c6i.4xlarge",
				"c6i.8xlarge",
				"c6i.16xlarge",
				"c6i.24xlarge",
				"c6in.large",
				"c6in.xlarge",
				"c6in.2xlarge",
				"c6in.4xlarge",
				"c6in.8xlarge",
				"c6in.16xlarge",
				"c6g.large",
				"c6g.xlarge",
				"c6g.2xlarge",
				"c6g.4xlarge",
				"c6g.8xlarge",
				"c6g.16xlarge",
				"c6gn.large",
				"c6gn.xlarge",
				"c6gn.2xlarge",
				"c6gn.4xlarge",
				"c6gn.8xlarge",
				"c6gn.16xlarge",
				"c7g.large",
				"c7g.xlarge",
				"c7g.2xlarge",
				"c7g.4xlarge",
				"c7g.8xlarge",
				"c7g.16xlarge",
				"c7gn.large",
				"c7gn.xlarge",
				"c7gn.2xlarge",
				"c7gn.4xlarge",
				"c7gn.8xlarge",
				"c7gn.16xlarge"
			]
		},
		"CIDRForInstanceAccess": {
			"Type": "String",
			"Default": "0.0.0.0/0",
			"Description": "Provide a network CIDR from which the FortiGate instances will be accessed",
			"AllowedPattern": "(\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}",
			"ConstraintDescription": "Must be a valid CIDR block"
		},
		"KeyPair": {
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Description": "Select a keypair to associate with the FortiGates"
		},
		"EncryptVolumes": {
			"Type": "String",
			"Description": "Select 'true' to encrypt the FortiGate instances OS and Log volumes with your account's KMS default master key for EBS.  Otherwise select false to leave unencrypted",
			"AllowedValues": [
				"true",
				"false"
			]
		},
		"OnlyPrivateEC2API": {
			"Type": "String",
			"Default": "False",
			"Description": "Select if only private EC2 API access is allowed for HAMgmt interfaces.  ***Note*** No EIP will be assigned to the HAMgmmt interfaces.  Login via the floating Cluster EIP or directly to each VM with the private IP of the HAMgmt interface.",
			"AllowedValues": [
				"True",
				"False"
			]
		},
		"InitS3Bucket": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank otherwise] Provide the Init S3 Bucket name, where your config files will be created. ***Note*** the bucket should exist in the same region as this deployment for successful bootstrapping"
		},
		"FortiOSVersion": {
			"Type": "String",
			"Default": "7.4.x",
			"Description": "Select the version of FortiOS to use (latest GA AMI will be used)",
			"AllowedValues": [
				"7.2.x",
				"7.4.x",
				"7.6.x"
			]
		},
		"LicenseType": {
			"Type": "String",
			"Description": "Select the license type for the FortiGates",
			"AllowedValues": [
				"BYOL",
				"Flex",
				"PAYG"
			]
		},
		"FortiGate1LicenseFile": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank otherwise] Provide the name of the BYOL license file in the Init S3 Bucket for FortiGate1 (ie fgt1.lic or prefix/fgt1.lic)"
		},
		"FortiGate2LicenseFile": {
			"Type": "String",
			"Description": "[BYOL Only, leave blank otherwise] Provide the name of the BYOL license file in the Init S3 Bucket for FortiGate2 (ie fgt2.lic or prefix/fgt2.lic)"
		},
		"FortiGate1FortiFlexToken": {
			"Type": "String",
			"Description": "[Flex Only, leave blank otherwise] Provide the FortiFlex Token for FortiGate1 (ie 1A2B3C4D5E6F7G8H9I0J)"
		},
		"FortiGate2FortiFlexToken": {
			"Type": "String",
			"Description": "[Flex Only, leave blank otherwise] Provide the FortiFlex Token for FortiGate2 (ie 2B3C4D5E6F7G8H9I0J1K)"
		}
	},
	"Mappings": {
		"FortiOSIntelAMISearchString": {
			"7.2.x": {
				"BYOL": "FortiGate-VM64-AWS *(7.2.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"Flex": "FortiGate-VM64-AWS *(7.2.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"PAYG": "FortiGate-VM64-AWSONDEMAND *(7.2.*)*|2wqkpek696qhdeo7lbbjncqli"
			},
			"7.4.x": {
				"BYOL": "FortiGate-VM64-AWS *(7.4.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"Flex": "FortiGate-VM64-AWS *(7.4.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"PAYG": "FortiGate-VM64-AWSONDEMAND *(7.4.*)*|2wqkpek696qhdeo7lbbjncqli"
			},
			"7.6.x": {
				"BYOL": "FortiGate-VM64-AWS *(7.6.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"Flex": "FortiGate-VM64-AWS *(7.6.*)*|dlaioq277sglm5mw1y1dmeuqa",
				"PAYG": "FortiGate-VM64-AWSONDEMAND *(7.6.*)*|2wqkpek696qhdeo7lbbjncqli"
			}
		},
		"FortiOSArmAMISearchString": {
			"7.2.x": {
				"BYOL": "FortiGate-VMARM64-AWS *(7.2.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"Flex": "FortiGate-VMARM64-AWS *(7.2.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"PAYG": "FortiGate-VMARM64-AWSONDEMAND *(7.2.*)*|8gc40z1w65qjt61p9ps88057n"
			},
			"7.4.x": {
				"BYOL": "FortiGate-VMARM64-AWS *(7.4.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"Flex": "FortiGate-VMARM64-AWS *(7.4.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"PAYG": "FortiGate-VMARM64-AWSONDEMAND *(7.4.*)*|8gc40z1w65qjt61p9ps88057n"
			},
			"7.6.x": {
				"BYOL": "FortiGate-VMARM64-AWS *(7.6.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"Flex": "FortiGate-VMARM64-AWS *(7.6.*)*|33ndn84xbrajb9vmu5lxnfpjq",
				"PAYG": "FortiGate-VMARM64-AWSONDEMAND *(7.6.*)*|8gc40z1w65qjt61p9ps88057n"
			}
		}
	},
	"Conditions": {
		"CreateAttachmentSubnets": {
			"Fn::Equals": [
				{
					"Ref": "Attachment"
				},
				"Yes"
			]
		},
		"CreateVpcRouteToFgt1InPrivRtb": {
			"Fn::Equals": [
				{
					"Ref": "Attachment"
				},
				"No"
			]
		},
		"CreateTgw": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "TgwCreation"
						},
						"Yes"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "Attachment"
						},
						"Yes"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "CwanCreation"
						},
						"No"
					]
				}
			]
		},
		"ExistingTgw": {
			"Fn::And": [
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "TgwExisting"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "TgwCreation"
						},
						"No"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "CwanCreation"
						},
						"No"
					]
				}
			]
		},
		"ExistingTgwRoute": {
			"Fn::And": [
				{
					"Condition": "ExistingTgw"
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "TgwExistingSpokeTgwRtbRoute"
								},
								""
							]
						}
					]
				}
			]
		},
		"CreateCwan": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "CwanCreation"
						},
						"Yes"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "Attachment"
						},
						"Yes"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "TgwCreation"
						},
						"No"
					]
				}
			]
		},
		"ExistingCwan": {
			"Fn::And": [
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "CwanExisting"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "CwanExistingSegmentKey"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "CwanExistingSegmentValue"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "CwanCreation"
						},
						"No"
					]
				},
				{
					"Fn::Equals": [
						{
							"Ref": "TgwCreation"
						},
						"No"
					]
				}
			]
		},
		"FortiFlex": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "LicenseType"
						},
						"Flex"
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiGate1FortiFlexToken"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiGate2FortiFlexToken"
								},
								""
							]
						}
					]
				}
			]
		},
		"BYOL": {
			"Fn::And": [
				{
					"Fn::Equals": [
						{
							"Ref": "LicenseType"
						},
						"BYOL"
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiGate1LicenseFile"
								},
								""
							]
						}
					]
				},
				{
					"Fn::Not": [
						{
							"Fn::Equals": [
								{
									"Ref": "FortiGate2LicenseFile"
								},
								""
							]
						}
					]
				}
			]
		},
		"Graviton": {
			"Fn::Or": [
				{
					"Fn::Equals": [
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										".",
										{
											"Ref": "InstanceType"
										}
									]
								}
							]
						},
						"c6g"
					]
				},
				{
					"Fn::Equals": [
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										".",
										{
											"Ref": "InstanceType"
										}
									]
								}
							]
						},
						"c6gn"
					]
				},
				{
					"Fn::Equals": [
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										".",
										{
											"Ref": "InstanceType"
										}
									]
								}
							]
						},
						"c7g"
					]
				},
				{
					"Fn::Equals": [
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										".",
										{
											"Ref": "InstanceType"
										}
									]
								}
							]
						},
						"c7gn"
					]
				}
			]
		},
		"PrivateEC2API": {
			"Fn::Equals": [
				{
					"Ref": "OnlyPrivateEC2API"
				},
				"True"
			]
		},
		"PublicEC2API": {
			"Fn::Equals": [
				{
					"Ref": "OnlyPrivateEC2API"
				},
				"False"
			]
		}
	},
	"Resources": {
		"VPC": {
			"Type": "AWS::EC2::VPC",
			"Properties": {
				"CidrBlock": {
					"Ref": "VPCCIDR"
				},
				"EnableDnsSupport": "true",
				"EnableDnsHostnames": "true",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-VPC"
						}
					}
				]
			}
		},
		"PublicSubnet1": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PublicSubnet1CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicSubnet1"
						}
					}
				]
			}
		},
		"PrivateSubnet1": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PrivateSubnet1CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateSubnet1"
						}
					}
				]
			}
		},
		"HAMgmtSubnet1": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "HAMgmtSubnet1CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-HAMgmtSubnet1"
						}
					}
				]
			}
		},
		"PublicSubnet2": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PublicSubnet2CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicSubnet2"
						}
					}
				]
			}
		},
		"PrivateSubnet2": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "PrivateSubnet2CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateSubnet2"
						}
					}
				]
			}
		},
		"HAMgmtSubnet2": {
			"Type": "AWS::EC2::Subnet",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "HAMgmtSubnet2CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-HAMgmtSubnet2"
						}
					}
				]
			}
		},
		"AttachmentSubnet1": {
			"Type": "AWS::EC2::Subnet",
			"Condition": "CreateAttachmentSubnets",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "AttachmentSubnet1CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-AttachmentSubnet1"
						}
					}
				]
			}
		},
		"AttachmentSubnet2": {
			"Type": "AWS::EC2::Subnet",
			"Condition": "CreateAttachmentSubnets",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"CidrBlock": {
					"Ref": "AttachmentSubnet2CIDR"
				},
				"AvailabilityZone": {
					"Ref": "AZForSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-AttachmentSubnet2"
						}
					}
				]
			}
		},
		"InternetGateway": {
			"Type": "AWS::EC2::InternetGateway",
			"Properties": {
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-IGW"
						}
					}
				]
			}
		},
		"AttachGateway": {
			"Type": "AWS::EC2::VPCGatewayAttachment",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"InternetGatewayId": {
					"Ref": "InternetGateway"
				}
			}
		},
		"TransitGateway": {
			"Type": "AWS::EC2::TransitGateway",
			"Condition": "CreateTgw",
			"Properties": {
				"AmazonSideAsn": 64512,
				"AutoAcceptSharedAttachments": "enable",
				"DefaultRouteTableAssociation": "disable",
				"DefaultRouteTablePropagation": "disable",
				"DnsSupport": "enable",
				"VpnEcmpSupport": "enable",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-TGW"
						}
					}
				]
			}
		},
		"TransitGatewayVpcAttachment": {
			"Type": "AWS::EC2::TransitGatewayAttachment",
			"Condition": "CreateTgw",
			"Properties": {
				"SubnetIds": [
					{
						"Ref": "AttachmentSubnet1"
					},
					{
						"Ref": "AttachmentSubnet2"
					}
				],
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				},
				"VpcId": {
					"Ref": "VPC"
				},
				"Options": {
					"ApplianceModeSupport": "enable"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-vpc-attachment"
						}
					}
				]
			}
		},
		"TransitGatewaySecurityRtb": {
			"Type": "AWS::EC2::TransitGatewayRouteTable",
			"Condition": "CreateTgw",
			"Properties": {
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-security-tgw-rtb"
						}
					}
				]
			}
		},
		"TransitGatewaySpokeRtb": {
			"Type": "AWS::EC2::TransitGatewayRouteTable",
			"Condition": "CreateTgw",
			"Properties": {
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-spoke-tgw-rtb"
						}
					}
				]
			}
		},
		"TransitGatewayVpcAttachmentAssociation": {
			"Type": "AWS::EC2::TransitGatewayRouteTableAssociation",
			"Condition": "CreateTgw",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "TransitGatewayVpcAttachment"
				},
				"TransitGatewayRouteTableId": {
					"Ref": "TransitGatewaySecurityRtb"
				}
			}
		},
		"TransitGatewayRoute1": {
			"Type": "AWS::EC2::TransitGatewayRoute",
			"Condition": "CreateTgw",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "TransitGatewayVpcAttachment"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"TransitGatewayRouteTableId": {
					"Ref": "TransitGatewaySpokeRtb"
				}
			}
		},
		"ExistingTransitGatewayVpcAttachment": {
			"Type": "AWS::EC2::TransitGatewayAttachment",
			"Condition": "ExistingTgw",
			"Properties": {
				"SubnetIds": [
					{
						"Ref": "AttachmentSubnet1"
					},
					{
						"Ref": "AttachmentSubnet2"
					}
				],
				"TransitGatewayId": {
					"Ref": "TgwExisting"
				},
				"VpcId": {
					"Ref": "VPC"
				},
				"Options": {
					"ApplianceModeSupport": "true"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-vpc-attachment"
						}
					}
				]
			}
		},
		"ExistingTransitGatewayVpcAttachmentAssociation": {
			"Type": "AWS::EC2::TransitGatewayRouteTableAssociation",
			"Condition": "ExistingTgw",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "ExistingTransitGatewayVpcAttachment"
				},
				"TransitGatewayRouteTableId": {
					"Ref": "TgwExistingSecurityTgwRtb"
				}
			}
		},
		"ExistingTransitGatewayRoute1": {
			"Type": "AWS::EC2::TransitGatewayRoute",
			"Condition": "ExistingTgwRoute",
			"Properties": {
				"TransitGatewayAttachmentId": {
					"Ref": "ExistingTransitGatewayVpcAttachment"
				},
				"DestinationCidrBlock": {
					"Ref": "TgwExistingSpokeTgwRtbRoute"
				},
				"TransitGatewayRouteTableId": {
					"Ref": "TgwExistingSpokeTgwRtb"
				}
			}
		},
		"GlobalNetwork": {
			"Type": "AWS::NetworkManager::GlobalNetwork",
			"Condition": "CreateCwan",
			"Properties": {
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-GlobalNetwork"
						}
					}
				]
			}
		},
		"CoreNetwork": {
			"Type": "AWS::NetworkManager::CoreNetwork",
			"Condition": "CreateCwan",
			"Properties": {
				"GlobalNetworkId": {
					"Ref": "GlobalNetwork"
				},
				"PolicyDocument": {
					"version": "2021.12",
					"core-network-configuration": {
						"asn-ranges": [
							"64512-64518"
						],
						"edge-locations": [
							{
								"location": {
									"Fn::Sub": "${AWS::Region}"
								},
								"asn": 64515
							}
						],
						"vpn-ecmp-support": true
					},
					"segments": [
						{
							"name": "production",
							"description": "production-segment",
							"edge-locations": [
								{
									"Ref": "AWS::Region"
								}
							],
							"require-attachment-acceptance": false,
							"isolate-attachments": false
						},
						{
							"name": "development",
							"description": "development-segment",
							"edge-locations": [
								{
									"Ref": "AWS::Region"
								}
							],
							"require-attachment-acceptance": false,
							"isolate-attachments": false
						},
						{
							"name": "sharedservices",
							"description": "sharedservices-segment",
							"edge-locations": [
								{
									"Ref": "AWS::Region"
								}
							],
							"require-attachment-acceptance": false,
							"isolate-attachments": false
						},
						{
							"name": "inspection",
							"description": "ngfw-segment",
							"edge-locations": [
								{
									"Ref": "AWS::Region"
								}
							],
							"require-attachment-acceptance": false,
							"isolate-attachments": false
						}
					],
					"segment-actions": [
						{
							"action": "share",
							"mode": "attachment-route",
							"segment": "production",
							"share-with": [
								"inspection"
							]
						},
						{
							"action": "share",
							"mode": "attachment-route",
							"segment": "development",
							"share-with": [
								"inspection"
							]
						},
						{
							"action": "share",
							"mode": "attachment-route",
							"segment": "sharedservices",
							"share-with": [
								"inspection"
							]
						}
					],
					"attachment-policies": [
						{
							"rule-number": 1,
							"condition-logic": "and",
							"conditions": [
								{
									"type": "tag-value",
									"key": "segment",
									"operator": "contains",
									"value": "production"
								}
							],
							"action": {
								"association-method": "constant",
								"segment": "production"
							}
						},
						{
							"rule-number": 2,
							"condition-logic": "and",
							"conditions": [
								{
									"type": "tag-value",
									"key": "segment",
									"operator": "contains",
									"value": "development"
								}
							],
							"action": {
								"association-method": "constant",
								"segment": "development"
							}
						},
						{
							"rule-number": 3,
							"condition-logic": "and",
							"conditions": [
								{
									"type": "tag-value",
									"key": "segment",
									"operator": "contains",
									"value": "sharedservices"
								}
							],
							"action": {
								"association-method": "constant",
								"segment": "sharedservices"
							}
						},
						{
							"rule-number": 4,
							"condition-logic": "and",
							"conditions": [
								{
									"type": "tag-value",
									"key": "segment",
									"operator": "contains",
									"value": "inspection"
								}
							],
							"action": {
								"association-method": "constant",
								"segment": "inspection"
							}
						}
					]
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-CoreNetwork"
						}
					}
				]
			}
		},
		"CloudWanVpcAttachment": {
			"Type": "AWS::NetworkManager::VpcAttachment",
			"Condition": "CreateCwan",
			"Properties": {
				"CoreNetworkId": {
					"Ref": "CoreNetwork"
				},
				"Options": {
					"ApplianceModeSupport": "true"
				},
				"SubnetArns": [
					{
						"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:subnet/${AttachmentSubnet1}"
					},
					{
						"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:subnet/${AttachmentSubnet2}"
					}
				],
				"VpcArn": {
					"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPC}"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-vpc-attacment"
						}
					},
					{
						"Key": "segment",
						"Value": "inspection"
					}
				]
			}
		},
		"ExistingCloudWanVpcAttachment": {
			"Type": "AWS::NetworkManager::VpcAttachment",
			"Condition": "ExistingCwan",
			"Properties": {
				"CoreNetworkId": {
					"Ref": "CwanExisting"
				},
				"Options": {
					"ApplianceModeSupport": "true"
				},
				"SubnetArns": [
					{
						"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:subnet/${AttachmentSubnet1}"
					},
					{
						"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:subnet/${AttachmentSubnet2}"
					}
				],
				"VpcArn": {
					"Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPC}"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-vpc-attacment"
						}
					},
					{
						"Key": {
							"Ref": "CwanExistingSegmentKey"
						},
						"Value": {
							"Ref": "CwanExistingSegmentValue"
						}
					}
				]
			}
		},
		"PublicRouteTable": {
			"Type": "AWS::EC2::RouteTable",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PublicRouteTable"
						}
					}
				]
			}
		},
		"PrivateRouteTable": {
			"Type": "AWS::EC2::RouteTable",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-PrivateRouteTable"
						}
					}
				]
			}
		},
		"AttachmentRouteTable": {
			"Type": "AWS::EC2::RouteTable",
			"Condition": "CreateAttachmentSubnets",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-AttachmentRouteTable"
						}
					}
				]
			}
		},
		"Route1": {
			"Type": "AWS::EC2::Route",
			"DependsOn": "AttachGateway",
			"Properties": {
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"GatewayId": {
					"Ref": "InternetGateway"
				}
			}
		},
		"Route2": {
			"Type": "AWS::EC2::Route",
			"Condition": "CreateAttachmentSubnets",
			"DependsOn": "Fgt1Eni1",
			"Properties": {
				"RouteTableId": {
					"Ref": "AttachmentRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"NetworkInterfaceId": {
					"Ref": "Fgt1Eni1"
				}
			}
		},
		"Route3": {
			"Type": "AWS::EC2::Route",
			"Condition": "CreateVpcRouteToFgt1InPrivRtb",
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"NetworkInterfaceId": {
					"Ref": "Fgt1Eni1"
				}
			}
		},
		"Route4": {
			"Type": "AWS::EC2::Route",
			"Condition": "CreateTgw",
			"DependsOn": [
				"TransitGateway",
				"TransitGatewayVpcAttachment",
				"TransitGatewayVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"TransitGatewayId": {
					"Ref": "TransitGateway"
				}
			}
		},
		"Route5": {
			"Type": "AWS::EC2::Route",
			"Condition": "ExistingTgw",
			"DependsOn": [
				"ExistingTransitGatewayVpcAttachment",
				"ExistingTransitGatewayVpcAttachmentAssociation"
			],
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"TransitGatewayId": {
					"Ref": "TgwExisting"
				}
			}
		},
		"Route6": {
			"Type": "AWS::EC2::Route",
			"Condition": "CreateCwan",
			"DependsOn": "CloudWanVpcAttachment",
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"CoreNetworkArn": {
					"Fn::Join": [
						"",
						[
							"arn:aws:networkmanager::",
							{
								"Ref": "AWS::AccountId"
							},
							":core-network/",
							{
								"Ref": "CoreNetwork"
							}
						]
					]
				}
			}
		},
		"Route7": {
			"Type": "AWS::EC2::Route",
			"Condition": "ExistingCwan",
			"DependsOn": "ExistingCloudWanVpcAttachment",
			"Properties": {
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				},
				"DestinationCidrBlock": "0.0.0.0/0",
				"CoreNetworkArn": {
					"Fn::Join": [
						"",
						[
							"arn:aws:networkmanager::",
							{
								"Ref": "AWS::AccountId"
							},
							":core-network/",
							{
								"Ref": "CwanExisting"
							}
						]
					]
				}
			}
		},
		"SubnetRouteTableAssociation1": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PublicSubnet1"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation2": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PublicSubnet2"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation3": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "HAMgmtSubnet1"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation4": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "HAMgmtSubnet2"
				},
				"RouteTableId": {
					"Ref": "PublicRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation5": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PrivateSubnet1"
				},
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation6": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Properties": {
				"SubnetId": {
					"Ref": "PrivateSubnet2"
				},
				"RouteTableId": {
					"Ref": "PrivateRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation7": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Condition": "CreateAttachmentSubnets",
			"Properties": {
				"SubnetId": {
					"Ref": "AttachmentSubnet1"
				},
				"RouteTableId": {
					"Ref": "AttachmentRouteTable"
				}
			}
		},
		"SubnetRouteTableAssociation8": {
			"Type": "AWS::EC2::SubnetRouteTableAssociation",
			"Condition": "CreateAttachmentSubnets",
			"Properties": {
				"SubnetId": {
					"Ref": "AttachmentSubnet2"
				},
				"RouteTableId": {
					"Ref": "AttachmentRouteTable"
				}
			}
		},
		"S3Endpoint": {
			"Type": "AWS::EC2::VPCEndpoint",
			"Condition": "BYOL",
			"Properties": {
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": "*",
							"Action": [
								"s3:GetObject"
							],
							"Resource": [
								"*"
							]
						}
					]
				},
				"RouteTableIds": [
					{
						"Ref": "PublicRouteTable"
					}
				],
				"ServiceName": {
					"Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
				},
				"VpcId": {
					"Ref": "VPC"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-S3Endpoint"
						}
					}
				]
			}
		},
		"VPCEndpointEC2": {
			"Type": "AWS::EC2::VPCEndpoint",
			"Condition": "PrivateEC2API",
			"Properties": {
				"VpcEndpointType": "Interface",
				"PrivateDnsEnabled": true,
				"VpcId": {
					"Ref": "VPC"
				},
				"SecurityGroupIds": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SubnetIds": [
					{
						"Ref": "HAMgmtSubnet1"
					},
					{
						"Ref": "HAMgmtSubnet2"
					}
				],
				"ServiceName": {
					"Fn::Join": [
						"",
						[
							"com.amazonaws.",
							{
								"Ref": "AWS::Region"
							},
							".ec2"
						]
					]
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-EC2Endpoint"
						}
					}
				]
			}
		},
		"InstanceRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"ec2.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "FGCPPolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Sid": "BootStrapFromS3",
									"Effect": "Allow",
									"Action": [
										"s3:GetObject"
									],
									"Resource": "*"
								},
								{
									"Sid": "Failover",
									"Effect": "Allow",
									"Action": [
										"ec2:AssociateAddress",
										"ec2:DescribeAddresses",
										"ec2:DescribeInstances",
										"ec2:DescribeRouteTables",
										"ec2:DescribeVpcEndpoints",
										"ec2:ReplaceRoute"
									],
									"Resource": "*"
								},
								{
									"Sid": "SDNConnectorFortiView",
									"Effect": "Allow",
									"Action": [
										"ec2:DescribeNetworkInterfaces",
										"ec2:DescribeRegions",
										"eks:DescribeCluster",
										"eks:ListClusters",
										"inspector:DescribeFindings",
										"inspector:ListFindings"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"InstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/",
				"Roles": [
					{
						"Ref": "InstanceRole"
					}
				]
			}
		},
		"FortiGateSecGrp": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"VpcId": {
					"Ref": "VPC"
				},
				"GroupDescription": "FortigateSecGrp",
				"SecurityGroupIngress": [
					{
						"Description": "Allow remote access to FGT",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "CIDRForInstanceAccess"
						}
					},
					{
						"Description": "Allow local VPC access to FGT",
						"IpProtocol": "-1",
						"FromPort": "0",
						"ToPort": "65535",
						"CidrIp": {
							"Ref": "VPCCIDR"
						}
					}
				]
			}
		},
		"FortiGateSecGrpHArule": {
			"DependsOn": "FortiGateSecGrp",
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "FortiGateSecGrp"
				},
				"Description": "Allow FGTs to access each other",
				"IpProtocol": "-1",
				"FromPort": "0",
				"ToPort": "65535",
				"SourceSecurityGroupId": {
					"Ref": "FortiGateSecGrp"
				}
			}
		},
		"Fgt1": {
			"Type": "AWS::EC2::Instance",
			"DependsOn": [
				"RunInitFunction1",
				"RunInitFunction2"
			],
			"Properties": {
				"ImageId": {
					"Fn::GetAtt": [
						"RunImageFunction",
						"ami"
					]
				},
				"InstanceType": {
					"Ref": "InstanceType"
				},
				"IamInstanceProfile": {
					"Ref": "InstanceProfile"
				},
				"KeyName": {
					"Ref": "KeyPair"
				},
				"BlockDeviceMappings": [
					{
						"DeviceName": "/dev/sda1",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "2",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					},
					{
						"DeviceName": "/dev/sdb",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "30",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt1Eni0"
						},
						"DeviceIndex": "0"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt1Eni1"
						},
						"DeviceIndex": "1"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt1Eni2"
						},
						"DeviceIndex": "2"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiGate1"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::If": [
							"BYOL",
							{
								"Fn::Sub": "{\"bucket\":\"${InitS3Bucket}\",\"region\":\"${AWS::Region}\",\"license\":\"/${FortiGate1LicenseFile}\",\"config\":\"/fgt1-config.txt\"}"
							},
							{
								"Fn::Join": [
									"\n",
									[
										"Content-Type: multipart/mixed; boundary='==Boundary=='",
										"MIME-Version: 1.0",
										"",
										"--==Boundary==",
										"Content-Type: text/x-shellscript; charset='us-ascii'",
										"MIME-Version: 1.0",
										"",
										{
											"Fn::GetAtt": [
												"RunInitFunction1",
												"fgt_config"
											]
										},
										"",
										{
											"Fn::If": [
												"FortiFlex",
												{
													"Fn::Join": [
														"\n",
														[
															"--==Boundary==",
															"Content-Type: text/plain; charset='us-ascii'",
															"MIME-Version: 1.0",
															"Content-Transfer-Encoding: 7bit",
															"Content-Disposition: attachment; filename='license'",
															"",
															{
																"Fn::Sub": "LICENSE-TOKEN: ${FortiGate1FortiFlexToken}"
															},
															""
														]
													]
												},
												{
													"Ref": "AWS::NoValue"
												}
											]
										},
										"--==Boundary==--"
									]
								]
							}
						]
					}
				}
			}
		},
		"Fgt2": {
			"Type": "AWS::EC2::Instance",
			"DependsOn": [
				"RunInitFunction1",
				"RunInitFunction2"
			],
			"Properties": {
				"ImageId": {
					"Fn::GetAtt": [
						"RunImageFunction",
						"ami"
					]
				},
				"InstanceType": {
					"Ref": "InstanceType"
				},
				"IamInstanceProfile": {
					"Ref": "InstanceProfile"
				},
				"KeyName": {
					"Ref": "KeyPair"
				},
				"BlockDeviceMappings": [
					{
						"DeviceName": "/dev/sda1",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "2",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					},
					{
						"DeviceName": "/dev/sdb",
						"Ebs": {
							"VolumeType": "gp2",
							"VolumeSize": "30",
							"DeleteOnTermination": "true",
							"Encrypted": {
								"Ref": "EncryptVolumes"
							}
						}
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt2Eni0"
						},
						"DeviceIndex": "0"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt2Eni1"
						},
						"DeviceIndex": "1"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "Fgt2Eni2"
						},
						"DeviceIndex": "2"
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-FortiGate2"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::If": [
							"BYOL",
							{
								"Fn::Sub": "{\"bucket\":\"${InitS3Bucket}\",\"region\":\"${AWS::Region}\",\"license\":\"/${FortiGate2LicenseFile}\",\"config\":\"/fgt2-config.txt\"}"
							},
							{
								"Fn::Join": [
									"\n",
									[
										"Content-Type: multipart/mixed; boundary='==Boundary=='",
										"MIME-Version: 1.0",
										"",
										"--==Boundary==",
										"Content-Type: text/x-shellscript; charset='us-ascii'",
										"MIME-Version: 1.0",
										"",
										{
											"Fn::GetAtt": [
												"RunInitFunction2",
												"fgt_config"
											]
										},
										"",
										{
											"Fn::If": [
												"FortiFlex",
												{
													"Fn::Join": [
														"\n",
														[
															"--==Boundary==",
															"Content-Type: text/plain; charset='us-ascii'",
															"MIME-Version: 1.0",
															"Content-Transfer-Encoding: 7bit",
															"Content-Disposition: attachment; filename='license'",
															"",
															{
																"Fn::Sub": "LICENSE-TOKEN: ${FortiGate2FortiFlexToken}"
															},
															""
														]
													]
												},
												{
													"Ref": "AWS::NoValue"
												}
											]
										},
										"--==Boundary==--"
									]
								]
							}
						]
					}
				}
			}
		},
		"Fgt1Eni0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port1",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PublicSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt1eni0"
						}
					},
					{
						"Key": "Interface",
						"Value": "eth0"
					}
				],
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "FortiGate1PublicIP"
										}
									]
								}
							]
						},
						"Primary": "true"
					}
				]
			}
		},
		"Fgt2Eni0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port1",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PublicSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt2eni0"
						}
					},
					{
						"Key": "Interface",
						"Value": "eth0"
					}
				],
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": {
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"/",
										{
											"Ref": "FortiGate2PublicIP"
										}
									]
								}
							]
						},
						"Primary": "true"
					}
				]
			}
		},
		"ClusterEIP": {
			"Type": "AWS::EC2::EIP",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-ClusterEIP"
						}
					}
				]
			}
		},
		"Fgt1EIP": {
			"Type": "AWS::EC2::EIP",
			"Condition": "PublicEC2API",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-Fgt1-HAMgmtEIP"
						}
					}
				]
			}
		},
		"Fgt2EIP": {
			"Type": "AWS::EC2::EIP",
			"Condition": "PublicEC2API",
			"Properties": {
				"Domain": "vpc",
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-Fgt2-HAMgmtEIP"
						}
					}
				]
			}
		},
		"ClusterIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"ClusterEIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fgt1Eni0"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate1PublicIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fgt1",
				"Fgt1Eni0",
				"ClusterEIP"
			]
		},
		"Fgt1Eni1": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port2",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PrivateSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt1eni1"
						}
					}
				],
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate1PrivateIP"
								}
							]
						}
					]
				}
			}
		},
		"Fgt2Eni1": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port2",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "PrivateSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt2eni1"
						}
					}
				],
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate2PrivateIP"
								}
							]
						}
					]
				}
			}
		},
		"Fgt1Eni2": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port3",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "HAMgmtSubnet1"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt1eni2"
						}
					}
				],
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate1HAmgmtIP"
								}
							]
						}
					]
				}
			}
		},
		"Fgt2Eni2": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": "port3",
				"GroupSet": [
					{
						"Ref": "FortiGateSecGrp"
					}
				],
				"SourceDestCheck": "false",
				"SubnetId": {
					"Ref": "HAMgmtSubnet2"
				},
				"Tags": [
					{
						"Key": "Name",
						"Value": {
							"Fn::Sub": "${AWS::StackName}-fgt2eni2"
						}
					}
				],
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate2HAmgmtIP"
								}
							]
						}
					]
				}
			}
		},
		"Fgt1EIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Condition": "PublicEC2API",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"Fgt1EIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fgt1Eni2"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate1HAmgmtIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fgt1",
				"Fgt1Eni2",
				"Fgt1EIP"
			]
		},
		"Fgt2EIPASSOCIATION": {
			"Type": "AWS::EC2::EIPAssociation",
			"Condition": "PublicEC2API",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"Fgt2EIP",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "Fgt2Eni2"
				},
				"PrivateIpAddress": {
					"Fn::Select": [
						"0",
						{
							"Fn::Split": [
								"/",
								{
									"Ref": "FortiGate2HAmgmtIP"
								}
							]
						}
					]
				}
			},
			"DependsOn": [
				"Fgt2",
				"Fgt2Eni2",
				"Fgt2EIP"
			]
		},
		"LambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"lambda.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "S3AccessRole",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"ec2:DescribeImages",
										"logs:CreateLogGroup",
										"logs:CreateLogStream",
										"logs:PutLogEvents",
										"s3:PutObject"
									],
									"Resource": "*"
								},
								{
									"Effect": "Allow",
									"Action": [
										"logs:*"
									],
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"ImageFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import boto3",
								"import cfnresponse",
								"import logging",
								"import json",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"client = boto3.client('ec2')",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"        searchString = event['ResourceProperties']['SearchString']",
								"        productCode =  event['ResourceProperties']['ProductCode']",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								"    try:",
								"        resp = client.describe_images(",
								"            Filters=[{'Name': 'name', 'Values': [searchString]}, {'Name': 'product-code', 'Values': [productCode]}],",
								"            Owners=['aws-marketplace']",
								"        )",
								"    except Exception as error:",
								"        logger.error('<--!! Exception: {}'.format(error))",
								"        responseData = {'msg':'Exception: {}'.format(error)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								"",
								"    if resp['ResponseMetadata']['HTTPStatusCode'] == 200 and resp['Images'] != []:",
								"        ami_dict = {}",
								"        ami_list = []",
								"        for entry in resp['Images']:",
								"            key = entry['CreationDate']",
								"            ami_dict[key] = entry['ImageId']",
								"        ami_list = sorted(ami_dict, reverse = True)",
								"        logger.info('--> found latest AMI: {}, {}, {} {}'.format(ami_dict[ami_list[0]], ami_list[0], searchString, productCode))",
								"        responseData = {'ami': ami_dict[ami_list[0]]}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"    else:",
								"        logger.error('!!--> Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode, resp))",
								"        responseData = {'msg':'Unable to find AMI {} {} in describe_images response! {}'.format(searchString, productCode,resp)}",
								"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
								""
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunImageFunction": {
			"Type": "Custom::ImageFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"ImageFunction",
						"Arn"
					]
				},
				"SearchString": {
					"Fn::If": [
						"Graviton",
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"|",
										{
											"Fn::FindInMap": [
												"FortiOSArmAMISearchString",
												{
													"Ref": "FortiOSVersion"
												},
												{
													"Ref": "LicenseType"
												}
											]
										}
									]
								}
							]
						},
						{
							"Fn::Select": [
								"0",
								{
									"Fn::Split": [
										"|",
										{
											"Fn::FindInMap": [
												"FortiOSIntelAMISearchString",
												{
													"Ref": "FortiOSVersion"
												},
												{
													"Ref": "LicenseType"
												}
											]
										}
									]
								}
							]
						}
					]
				},
				"ProductCode": {
					"Fn::If": [
						"Graviton",
						{
							"Fn::Select": [
								"1",
								{
									"Fn::Split": [
										"|",
										{
											"Fn::FindInMap": [
												"FortiOSArmAMISearchString",
												{
													"Ref": "FortiOSVersion"
												},
												{
													"Ref": "LicenseType"
												}
											]
										}
									]
								}
							]
						},
						{
							"Fn::Select": [
								"1",
								{
									"Fn::Split": [
										"|",
										{
											"Fn::FindInMap": [
												"FortiOSIntelAMISearchString",
												{
													"Ref": "FortiOSVersion"
												},
												{
													"Ref": "LicenseType"
												}
											]
										}
									]
								}
							]
						}
					]
				}
			}
		},
		"InitFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"\n",
							[
								"import ast",
								"import boto3",
								"import cfnresponse",
								"import json",
								"import logging",
								"logger = logging.getLogger()",
								"logger.setLevel(logging.INFO)",
								"s3 = boto3.client('s3')",
								"",
								"template = '''\\",
								"config system vdom-exception",
								"edit 1",
								"set object system.interface",
								"next",
								"edit 2",
								"set object router.bgp",
								"next",
								"edit 3",
								"set object router.static",
								"next",
								"end",
								"config system settings",
								"set allow-subnet-overlap enable",
								"end",
								"config system global",
								"set hostname {Hostname}",
								"set admintimeout 60",
								"end",
								{
									"Fn::If": [
										"PrivateEC2API",
										{
											"Fn::Join": [
												"\n",
												[
													"config system dns",
													"set primary 169.254.169.253",
													"unset secondary",
													"unset protocol",
													"unset server-select-method",
													"end"
												]
											]
										},
										{
											"Ref": "AWS::NoValue"
										}
									]
								},
								"config system interface",
								"edit port1",
								"set alias public",
								"set mode static",
								"set ip {Port1IP}",
								"set allowaccess ping https",
								"set secondary-IP enable",
								"next",
								"edit port2",
								"set alias private",
								"set mode static",
								"set ip {Port2IP}",
								"set allowaccess ping https",
								"set mtu-override enable",
								"set mtu 9001",
								"next",
								"edit port3",
								"set alias hamgmt",
								"set mode static",
								"set ip {Port3IP}",
								"set allowaccess ping https",
								"set mtu-override enable",
								"set mtu 9001",
								"next",
								"end",
								"config router static",
								"edit 1",
								"set device port1",
								"set gateway {PublicSubnetRouterIP}",
								"set comment default-route",
								"next",
								"edit 2",
								"set dst {VPCCIDR}",
								"set device port2",
								"set gateway {PrivateSubnetRouterIP}",
								"set comment vpc-route",
								"next",
								{
									"Fn::If": [
										"CreateAttachmentSubnets",
										{
											"Fn::Join": [
												"\n",
												[
													"edit 3",
													"set dst 10.0.0.0/8",
													"set device port2",
													"set gateway {PrivateSubnetRouterIP}",
													"set comment rfc1918-class-a-route",
													"next",
													"edit 4",
													"set dst 172.16.0.0/12",
													"set device port2",
													"set gateway {PrivateSubnetRouterIP}",
													"set comment rfc1918-class-b-route",
													"next",
													"edit 5",
													"set dst 192.168.0.0/16",
													"set device port2",
													"set gateway {PrivateSubnetRouterIP}",
													"set comment rfc1918-class-c-route",
													"next"
												]
											]
										},
										{
											"Ref": "AWS::NoValue"
										}
									]
								},
								"end",
								"config firewall policy",
								"edit 1",
								"set name outbound-all",
								"set srcintf port2",
								"set dstintf port1",
								"set srcaddr all",
								"set dstaddr all",
								"set action accept",
								"set schedule always",
								"set service ALL",
								"set logtraffic all",
								"set nat enable",
								"next",
								"end",
								"config system sdn-connector",
								"edit aws-instance-role",
								"set status enable",
								"set type aws",
								"set use-metadata-iam enable",
								"set alt-resource-ip enable",
								"next",
								"end",
								"config system ha",
								"set group-name group1",
								"set mode a-p",
								"set hbdev port3 50",
								"set session-pickup enable",
								"set ha-mgmt-status enable",
								"config ha-mgmt-interface",
								"edit 1",
								"set interface port3",
								"set gateway {HAmgmtSubnetRouterIP}",
								"next",
								"end",
								"set override disable",
								"set priority {HApriority}",
								"set unicast-hb enable",
								"set unicast-hb-peerip {HApeer}",
								"set ha-uptime-diff-margin 60",
								"set route-ttl 30",
								{
									"Fn::Join": [
										"",
										[
											"set password ",
											{
												"Fn::Base64": {
													"Ref": "AWS::AccountId"
												}
											}
										]
									]
								},
								"end",
								"\\",
								"'''",
								"",
								"def handler(event, context):",
								"    if event['RequestType'] == 'Create':",
								"        logger.info('<-- event received: {}'.format(json.dumps(event)))",
								"        dict = ast.literal_eval(event['ResourceProperties']['FGTInfo'])",
								"        fgt_config = template.format(**dict)",
								"    else:",
								"        responseData = {'msg':'200'}",
								"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
								"        return None",
								"",
								{
									"Fn::If": [
										"BYOL",
										{
											"Fn::Join": [
												"\n",
												[
													"    try:",
													"        response = s3.put_object(Body=fgt_config, Bucket=event['ResourceProperties']['S3Bucket'], Key=event['ResourceProperties']['S3Key'])",
													"    except Exception as error:",
													"        logger.error('<--!! Exception: {}'.format(error))",
													"        responseData = {'msg':'Exception: {}'.format(error)}",
													"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
													"        return None",
													"",
													"    if response['ResponseMetadata']['HTTPStatusCode'] == 200:",
													"        logger.info('<-- s3 put_object {} successful'.format(event['ResourceProperties']['S3Key']))",
													"        responseData = {'fgt_config':fgt_config}",
													"        cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
													"    else:",
													"        responseData = {'msg':'error'}",
													"        cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
													""
												]
											]
										},
										{
											"Fn::Join": [
												"\n",
												[
													"    responseData = {'fgt_config':fgt_config}",
													"    cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
													""
												]
											]
										}
									]
								}
							]
						]
					}
				},
				"Role": {
					"Fn::GetAtt": [
						"LambdaRole",
						"Arn"
					]
				},
				"Timeout": 120,
				"Handler": "index.handler",
				"Runtime": "python3.12",
				"MemorySize": 128
			}
		},
		"RunInitFunction1": {
			"Type": "Custom::InitFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"InitFunction",
						"Arn"
					]
				},
				"S3Bucket": {
					"Ref": "InitS3Bucket"
				},
				"S3Key": "fgt1-config.txt",
				"FGTInfo": {
					"Fn::Join": [
						"",
						[
							"{",
							"'VPCCIDR':'",
							{
								"Ref": "VPCCIDR"
							},
							"',",
							"'HAmgmtSubnetRouterIP':'",
							{
								"Ref": "HAMgmtSubnet1RouterIP"
							},
							"',",
							"'PublicSubnetRouterIP':'",
							{
								"Ref": "PublicSubnet1RouterIP"
							},
							"',",
							"'PrivateSubnetRouterIP':'",
							{
								"Ref": "PrivateSubnet1RouterIP"
							},
							"',",
							"'Port1IP':'",
							{
								"Ref": "FortiGate1PublicIP"
							},
							"',",
							"'Port2IP':'",
							{
								"Ref": "FortiGate1PrivateIP"
							},
							"',",
							"'Port3IP':'",
							{
								"Ref": "FortiGate1HAmgmtIP"
							},
							"',",
							"'HApeer':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "FortiGate2HAmgmtIP"
											}
										]
									}
								]
							},
							"',",
							"'HApriority':'255',",
							"'Hostname':'Fgt1'",
							"}"
						]
					]
				}
			}
		},
		"RunInitFunction2": {
			"Type": "Custom::InitFunction",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": [
						"InitFunction",
						"Arn"
					]
				},
				"S3Bucket": {
					"Ref": "InitS3Bucket"
				},
				"S3Key": "fgt2-config.txt",
				"FGTInfo": {
					"Fn::Join": [
						"",
						[
							"{",
							"'VPCCIDR':'",
							{
								"Ref": "VPCCIDR"
							},
							"',",
							"'HAmgmtSubnetRouterIP':'",
							{
								"Ref": "HAMgmtSubnet2RouterIP"
							},
							"',",
							"'PublicSubnetRouterIP':'",
							{
								"Ref": "PublicSubnet2RouterIP"
							},
							"',",
							"'PrivateSubnetRouterIP':'",
							{
								"Ref": "PrivateSubnet2RouterIP"
							},
							"',",
							"'Port1IP':'",
							{
								"Ref": "FortiGate2PublicIP"
							},
							"',",
							"'Port2IP':'",
							{
								"Ref": "FortiGate2PrivateIP"
							},
							"',",
							"'Port3IP':'",
							{
								"Ref": "FortiGate2HAmgmtIP"
							},
							"',",
							"'HApeer':'",
							{
								"Fn::Select": [
									"0",
									{
										"Fn::Split": [
											"/",
											{
												"Ref": "FortiGate1HAmgmtIP"
											}
										]
									}
								]
							},
							"',",
							"'HApriority':'1',",
							"'Hostname':'Fgt2'",
							"}"
						]
					]
				}
			}
		}
	},
	"Outputs": {
		"Username": {
			"Value": "admin",
			"Description": "Username for the Fortigates"
		},
		"Password": {
			"Value": {
				"Ref": "Fgt1"
			},
			"Description": "Initial password for the FortiGates"
		},
		"ClusterLoginURL": {
			"Value": {
				"Fn::Join": [
					"",
					[
						"https://",
						{
							"Ref": "ClusterEIP"
						}
					]
				]
			},
			"Description": "Login URL for the public interface of the active FortiGate"
		},
		"FortiGate1LoginURL": {
			"Value": {
				"Fn::If": [
					"PrivateEC2API",
					{
						"Fn::Join": [
							"",
							[
								"https://",
								{
									"Fn::Select": [
										"0",
										{
											"Fn::Split": [
												"/",
												{
													"Ref": "FortiGate1HAmgmtIP"
												}
											]
										}
									]
								}
							]
						]
					},
					{
						"Fn::Join": [
							"",
							[
								"https://",
								{
									"Ref": "Fgt1EIP"
								}
							]
						]
					}
				]
			},
			"Description": "Login URL for the HAmgmt interface of FortiGate1"
		},
		"FortiGate2LoginURL": {
			"Value": {
				"Fn::If": [
					"PrivateEC2API",
					{
						"Fn::Join": [
							"",
							[
								"https://",
								{
									"Fn::Select": [
										"0",
										{
											"Fn::Split": [
												"/",
												{
													"Ref": "FortiGate2HAmgmtIP"
												}
											]
										}
									]
								}
							]
						]
					},
					{
						"Fn::Join": [
							"",
							[
								"https://",
								{
									"Ref": "Fgt2EIP"
								}
							]
						]
					}
				]
			},
			"Description": "Login URL for the HAmgmt interface of FortiGate2"
		},
		"TransitGateway": {
			"Value": {
				"Ref": "TransitGateway"
			},
			"Condition": "CreateTgw",
			"Description": "Transit Gateway ID, for use in spoke template"
		},
		"TransitGatewaySecurityRtb": {
			"Value": {
				"Ref": "TransitGatewaySecurityRtb"
			},
			"Condition": "CreateTgw",
			"Description": "Transit Gateway Route Table ID that the security VPC is associated to, for use in spoke template"
		},
		"TransitGatewaySpokeRtb": {
			"Value": {
				"Ref": "TransitGatewaySpokeRtb"
			},
			"Condition": "CreateTgw",
			"Description": "Transit Gateway Route Table ID that the spoke VPCs will associate to, for use in spoke template"
		},
		"ExistingTransitGateway": {
			"Value": {
				"Ref": "TgwExisting"
			},
			"Condition": "ExistingTgw",
			"Description": "Existing Transit Gateway ID, for use in spoke template"
		},
		"ExistingTransitGatewaySecurityRtb": {
			"Value": {
				"Ref": "TgwExistingSecurityTgwRtb"
			},
			"Condition": "ExistingTgw",
			"Description": "Existing Transit Gateway Route Table ID that the security VPC is associated to, for use in spoke template"
		},
		"ExistingTransitGatewaySpokeRtb": {
			"Value": {
				"Ref": "TgwExistingSpokeTgwRtb"
			},
			"Condition": "ExistingTgw",
			"Description": "Existing Transit Gateway Route Table ID that the spoke VPCs will associate to, for use in spoke template"
		},
		"CloudWAN": {
			"Value": {
				"Ref": "CoreNetwork"
			},
			"Condition": "CreateCwan",
			"Description": "Cloud WAN Core Network ID, for use in spoke template"
		},
		"CloudWanSegmentKey": {
			"Value": "segment",
			"Condition": "CreateCwan",
			"Description": "Cloud WAN segment key, for use in spoke template"
		},
		"ClouCloudWanSegmentValue": {
			"Value": "production,development,sharedservices",
			"Condition": "CreateCwan",
			"Description": "Cloud WAN segment value (use one of the examples), for use in spoke template"
		},
		"ExistingCloudWAN": {
			"Value": {
				"Ref": "CwanExisting"
			},
			"Condition": "ExistingCwan",
			"Description": "Existing Cloud WAN Core Network ID, for use in spoke template"
		}
	}
}